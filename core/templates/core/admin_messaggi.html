{% extends 'base.html' %}
{% load static %}

{% block title %}Messaggi Ricevuti{% endblock %}

{% block content %}
<div class="container py-5">
  <h2 class="fw-bold mb-4">📥 Messaggi ricevuti</h2>

  {% if messaggi %}
    <div class="accordion" id="messaggiAccordion">
      {% for m in messaggi %}
      <div class="accordion-item border rounded shadow-sm mb-3 {% if not m.letto %}bg-light{% endif %}">
        <h2 class="accordion-header" id="heading{{ m.id }}">
          <button class="accordion-button {% if m.letto %}collapsed{% endif %}" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ m.id }}" aria-expanded="true" aria-controls="collapse{{ m.id }}">
            <div class="w-100 d-flex justify-content-between align-items-center">
              <span>
                <strong>{{ m.oggetto }}</strong><br>
                <small>{{ m.email }}</small>
              </span>
              {% if not m.letto %}
                <span class="badge bg-danger">NUOVO</span>
              {% endif %}
            </div>
          </button>
        </h2>
        <div id="collapse{{ m.id }}" class="accordion-collapse collapse {% if not m.letto %}show{% endif %}" aria-labelledby="heading{{ m.id }}" data-bs-parent="#messaggiAccordion">
          <div class="accordion-body">
            <p class="mb-3">{{ m.messaggio }}</p>

            {% if m.allegato %}
              <div class="mb-3">
                <strong>📎 Allegato:</strong>
                <a href="{{ m.allegato.url }}" class="btn btn-sm btn-outline-secondary ms-2" download target="_blank">
                  Scarica file
                </a>
              </div>
            {% endif %}

            <small class="text-muted">Ricevuto il: {{ m.data_invio|date:"d/m/Y H:i" }}</small>

            <hr>

            <!-- Form risposta con allegato -->
            <form method="post" action="{% url 'admin-rispondi' m.id %}" class="mt-4" enctype="multipart/form-data">
              {% csrf_token %}
              <div class="mb-3">
                <label for="oggetto{{ m.id }}" class="form-label">Oggetto della risposta</label>
                <input type="text" name="oggetto" id="oggetto{{ m.id }}" class="form-control" placeholder="Oggetto..." required>
              </div>
              <div class="mb-3">
                <label for="risposta{{ m.id }}" class="form-label">Risposta</label>
                <textarea name="risposta" id="risposta{{ m.id }}" class="form-control" rows="6" placeholder="Scrivi la tua risposta..." required></textarea>
              </div>
              <div class="mb-4">
                <label for="allegato_risposta_{{ m.id }}" class="form-label">📎 Allega un file alla risposta (opzionale)</label>
                <input type="file" name="allegato_risposta" id="allegato_risposta_{{ m.id }}" class="form-control">
              </div>
              <button type="submit" class="btn btn-success">📤 Invia Risposta</button>
            </form>

            <!-- Azioni aggiuntive -->
            <div class="mt-4 d-flex justify-content-between align-items-center border-top pt-3">
              <form method="post" action="{% url 'admin-elimina-messaggio' m.id %}">
                {% csrf_token %}
                <button class="btn btn-outline-danger btn-sm" onclick="return confirm('Sei sicuro di voler eliminare questo messaggio?')">🗑️ Elimina</button>
              </form>
              {# Se vuoi anche un pulsante per segnarlo come letto, togli il commento qui sotto #}
              {# <form method="post" action="{% url 'admin-lettura-messaggio' m.id %}"> #}
              {#   {% csrf_token %} #}
              {#   <button class="btn btn-outline-primary btn-sm">✅ Segna come letto</button> #}
              {# </form> #}
            </div>

          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="alert alert-info">Nessun messaggio ricevuto.</div>
  {% endif %}
</div>
{% endblock %}

