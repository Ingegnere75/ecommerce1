{% extends 'base.html' %}
{% load static %}
{% block title %}Modifica Entrata{% endblock %}

{% block content %}
<div class="container py-5">

  <!-- Pulsanti Torna -->
  <div class="mb-4">
    <a href="{% url 'admin-dashboard' %}" class="btn btn-outline-primary rounded-pill mb-2">
      <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
    </a>
    <a href="{% url 'magazzino_entrate' %}" class="btn btn-outline-secondary rounded-pill shadow-sm">
      <i class="fas fa-arrow-left me-1"></i> Torna alla Lista Arrivi
    </a>
  </div>

  <!-- Titolo -->
  <h2 class="text-center mb-5 display-6 fw-bold text-primary" style="font-family: 'Playfair Display', serif;">
    üìù Modifica Dati Entrata in Magazzino
  </h2>

  <!-- Form -->
  <div class="card border-0 shadow-lg p-4 bg-white">
    <form method="POST" class="row g-4">
      {% csrf_token %}
      {% for field in form %}
        <div class="col-md-6">
          <label for="{{ field.id_for_label }}" class="form-label fw-semibold text-dark">
            <i class="fas fa-pen me-1 text-muted"></i> {{ field.label }}
          </label>

          {% if field.name == 'data_arrivo' %}
            <input type="date" name="{{ field.name }}" id="{{ field.id_for_label }}" class="form-control" value="{{ field.value|default:'' }}">

          {% elif field.name == 'prezzo_totale' or field.name == 'codice_arrivo' %}
            <input type="text" name="{{ field.name }}" id="{{ field.id_for_label }}"
                   class="form-control bg-light text-muted" readonly
                   value="{{ field.value|default:'' }}" aria-readonly="true">

          {% elif field.name == 'aggiunto' %}
            <div class="form-check mt-2">
              {{ field }}
              <label class="form-check-label ms-2" for="{{ field.id_for_label }}">Aggiunto</label>
            </div>

          {% else %}
            {{ field }}
          {% endif %}

          {% if field.errors %}
            <div class="text-danger small mt-1">{{ field.errors }}</div>
          {% endif %}
        </div>
      {% endfor %}

      <div class="col-12 text-end pt-3">
        <button type="submit" class="btn btn-success btn-lg rounded-pill px-5 shadow-sm">
          <i class="fas fa-save me-1"></i> Salva Modifiche
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Script: Calcolo automatico prezzo totale -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const quantitaInput = document.getElementById('id_quantita');
    const prezzoInput = document.getElementById('id_prezzo_con_iva');
    const trasportoInput = document.getElementById('id_prezzo_trasporto');
    const totaleInput = document.getElementById('id_prezzo_totale');

    function calcolaTotale() {
      const q = parseFloat(quantitaInput?.value.replace(',', '.')) || 0;
      const p = parseFloat(prezzoInput?.value.replace(',', '.')) || 0;
      const t = parseFloat(trasportoInput?.value.replace(',', '.')) || 0;
      const totale = (q * p + t).toFixed(2);
      if (totaleInput) totaleInput.value = totale;
    }

    quantitaInput?.addEventListener('input', calcolaTotale);
    prezzoInput?.addEventListener('input', calcolaTotale);
    trasportoInput?.addEventListener('input', calcolaTotale);
  });
</script>

<!-- Script: Autocompletamento da codice prodotto -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const codiceInput = document.getElementById('id_codice_prodotto');
    if (codiceInput) {
      codiceInput.addEventListener('change', function () {
        const codice = this.value;
        fetch(`/amministratore/get_prodotto_info/?codice_prodotto=${codice}`)
          .then(response => response.json())
          .then(data => {
            if (data.nome_prodotto) {
              document.getElementById('id_nome_prodotto').value = data.nome_prodotto;
              document.getElementById('id_codice_magazzino').value = data.codice_magazzino;
              document.getElementById('id_prezzo_con_iva').value = data.prezzo_con_iva;
            }
          });
      });
    }
  });
</script>
{% endblock %}
