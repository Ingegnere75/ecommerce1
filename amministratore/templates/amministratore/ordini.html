{% extends 'base.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Gestione Ordini{% endblock %}

{% block content %}
<div class="container mt-5">

  <a href="{% url 'admin-dashboard' %}" class="btn btn-outline-primary rounded-pill mb-4">
    <i class="fas fa-arrow-left me-1"></i> Torna alla Dashboard
  </a>

  <h2 class="fw-bold text-gradient mb-4">üì¶ Lista Ordini</h2>

  {% if ordini %}
  <div class="accordion" id="ordiniAccordion">

    {% for ordine in ordini %}
    <div class="accordion-item mb-3 shadow-sm rounded">
      <h2 class="accordion-header" id="heading{{ ordine.id }}">
        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ ordine.id }}">
          Ordine #{{ ordine.id }} |
          {% if ordine.cliente %}
            {{ ordine.cliente.first_name }} {{ ordine.cliente.last_name }}
          {% else %}
            Utente ospite
          {% endif %}
           - {{ ordine.data_creazione|date:"d/m/Y H:i" }}
        </button>
      </h2>

      <div id="collapse{{ ordine.id }}" class="accordion-collapse collapse" data-bs-parent="#ordiniAccordion">
        <div class="accordion-body">

          <p><strong>Stato:</strong>
            {% if ordine.stato == 'in_attesa' %}
              <span class="badge bg-warning text-dark">In attesa</span>
            {% elif ordine.stato == 'spedito' %}
              <span class="badge bg-info text-dark">Spedito</span>
            {% elif ordine.stato == 'consegnato' %}
              <span class="badge bg-success">Consegnato</span>
            {% else %}
              <span class="badge bg-secondary">Sconosciuto</span>
            {% endif %}
          </p>

          <p><strong>Spedizione:</strong> {{ ordine.nome }} {{ ordine.cognome }}, {{ ordine.indirizzo }} {{ ordine.civico }}, {{ ordine.cap }} {{ ordine.citta }} ({{ ordine.provincia }})</p>

          {% if ordine.fatturazione_diversa %}
          <p><strong>Fatturazione:</strong> {{ ordine.nome_fatt }} {{ ordine.cognome_fatt }}, {{ ordine.indirizzo_fatt }} {{ ordine.civico_fatt }}, {{ ordine.cap_fatt }} {{ ordine.citta_fatt }} ({{ ordine.provincia_fatt }})</p>
          {% endif %}

          <div class="table-responsive mt-4">
            <table class="table table-bordered text-center align-middle">
              <thead class="table-light">
                <tr>
                  <th>Prodotto</th>
                  <th>Prezzo unitario</th>
                  <th>Quantit√†</th>
                  <th>Totale riga</th>
                  <th>Pagato</th>
                </tr>
              </thead>
              <tbody>
                {% for item in ordine.ordineitem_set.all %}
                <tr>
                  <td>{{ item.prodotto.nome }}</td>
                  <td>‚Ç¨ {{ item.prezzo_unitario|floatformat:2 }}</td>
                  <td>{{ item.quantita }}</td>
                  <td class="fw-bold text-success">
                    ‚Ç¨ {{ item.get_subtotale|floatformat:2 }}
                  </td>
                  {% if forloop.first %}
                  <td rowspan="{{ ordine.ordineitem_set.count }}" class="align-middle">
                    {% if ordine.pagato %}
                      <span class="badge bg-success">‚úÖ S√¨</span>
                    {% else %}
                      <span class="badge bg-danger">‚ùå No</span>
                    {% endif %}
                  </td>
                  {% endif %}
                </tr>
                {% endfor %}
              </tbody>
              <tfoot class="table-primary">
                <tr>
                  <td colspan="3" class="text-end fw-bold">Totale Ordine:</td>
                  <td class="fw-bold text-primary">‚Ç¨ {{ ordine.get_totale|floatformat:2 }}</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>

          <div class="d-flex flex-wrap gap-2 mt-3">
            <a href="{% url 'esporta_ordine' ordine.id %}" class="btn btn-outline-danger">
              <i class="fas fa-file-pdf"></i> Esporta in PDF
            </a>

            {% if not ordine.pagato %}
            <form method="post" action="{% url 'elimina_ordine_non_pagato' ordine.id %}" onsubmit="return confirm('Vuoi davvero eliminare questo ordine non pagato?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-secondary">
                <i class="fas fa-trash-alt"></i> Elimina Ordine
              </button>
            </form>
            {% endif %}
          </div>

        </div>
      </div>
    </div>
    {% endfor %}

  </div>
  {% else %}
  <div class="alert alert-warning text-center mt-5">
    Nessun ordine trovato al momento.
  </div>
  {% endif %}

</div>
{% endblock %}
